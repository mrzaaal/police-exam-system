-- SCRIPT DATABASE FINAL LENGKAP (KOMPATIBEL DENGAN VERSI MYSQL/MARIADB LAMA)
-- Skrip ini aman untuk dijalankan berulang kali.

-- =============================================
-- ===== HAPUS TABEL LAMA JIKA ADA =====
-- =============================================
SET FOREIGN_KEY_CHECKS = 0;
DROP TABLE IF EXISTS `users`, `questions`, `question_sets`, `question_set_items`, `exam_schedules`, `schedule_questions`, `exam_sessions`, `exam_progress`, `results`, `essay_submissions`, `question_analytics`, `exam_events`, `login_attempts`, `audit_trail`;
SET FOREIGN_KEY_CHECKS = 1;


-- =============================================
-- ===== TABEL INTI PENGGUNA & KONTEN =====
-- =============================================

-- Tabel untuk pengguna (peserta, admin, penilai)
CREATE TABLE `users` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `username` VARCHAR(50) NOT NULL UNIQUE,
  `name` VARCHAR(100) NOT NULL,
  `email` VARCHAR(100) NULL UNIQUE,
  `password` VARCHAR(255) NOT NULL,
  `role` ENUM('participant', 'admin', 'grader') NOT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Tabel untuk bank soal
CREATE TABLE `questions` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `question_text` TEXT NOT NULL,
  `image_url` VARCHAR(255) NULL DEFAULT NULL,
  `question_type` ENUM('multiple-choice', 'essay') NOT NULL DEFAULT 'multiple-choice',
  `options` TEXT NULL, -- Diubah dari JSON ke TEXT
  `correct_answer_index` INT NULL,
  `topic` VARCHAR(100) DEFAULT 'Umum',
  `difficulty` ENUM('low', 'medium', 'high') NOT NULL DEFAULT 'medium',
  `competency` VARCHAR(255) NULL DEFAULT 'Umum',
  `status` ENUM('draft', 'approved') NOT NULL DEFAULT 'draft',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Tabel untuk paket soal (blueprint)
CREATE TABLE `question_sets` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `name` VARCHAR(255) NOT NULL,
  `description` TEXT NULL,
  `created_by` INT,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`created_by`) REFERENCES `users`(`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Tabel penghubung antara paket soal dan soal
CREATE TABLE `question_set_items` (
  `set_id` INT NOT NULL,
  `question_id` INT NOT NULL,
  PRIMARY KEY (`set_id`, `question_id`),
  FOREIGN KEY (`set_id`) REFERENCES `question_sets`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`question_id`) REFERENCES `questions`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


-- =============================================
-- ===== TABEL OPERASIONAL UJIAN =====
-- =============================================

-- Tabel untuk jadwal ujian
CREATE TABLE `exam_schedules` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `title` VARCHAR(255) NOT NULL,
  `start_time` DATETIME NOT NULL,
  `end_time` DATETIME NOT NULL,
  `duration_minutes` INT NOT NULL,
  `max_attempts` INT NOT NULL DEFAULT 1,
  `is_active` BOOLEAN NOT NULL DEFAULT TRUE,
  `results_released` BOOLEAN NOT NULL DEFAULT FALSE,
  `analysis_status` ENUM('not_run', 'completed') NOT NULL DEFAULT 'not_run',
  `created_by` INT,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`created_by`) REFERENCES `users`(`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Tabel penghubung antara jadwal dan soal
CREATE TABLE `schedule_questions` (
  `schedule_id` INT NOT NULL,
  `question_id` INT NOT NULL,
  PRIMARY KEY (`schedule_id`, `question_id`),
  FOREIGN KEY (`schedule_id`) REFERENCES `exam_schedules`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`question_id`) REFERENCES `questions`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Tabel untuk sesi ujian aktif
CREATE TABLE `exam_sessions` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `user_id` INT NOT NULL UNIQUE,
  `username` VARCHAR(50) NOT NULL,
  `start_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `last_update` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `status` ENUM('active', 'finished') NOT NULL DEFAULT 'active',
  `progress` INT NOT NULL DEFAULT 0,
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Tabel untuk menyimpan progres ujian (jawaban, dll)
CREATE TABLE `exam_progress` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `session_id` INT NOT NULL UNIQUE,
  `user_id` INT NOT NULL,
  `shuffled_questions_json` TEXT NOT NULL, -- Diubah dari JSON ke TEXT
  `answers_json` TEXT, -- Diubah dari JSON ke TEXT
  `flags_json` TEXT, -- Diubah dari JSON ke TEXT
  FOREIGN KEY (`session_id`) REFERENCES `exam_sessions`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


-- =============================================
-- ===== TABEL HASIL & ANALISIS =====
-- =============================================

-- Tabel untuk hasil akhir ujian
CREATE TABLE `results` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `user_id` INT NOT NULL,
  `schedule_id` INT NULL,
  `attempt_number` INT NOT NULL DEFAULT 1,
  `username` VARCHAR(50) NOT NULL,
  `name` VARCHAR(100) NOT NULL,
  `score` DECIMAL(5, 2) NOT NULL,
  `status` VARCHAR(20) NOT NULL,
  `grading_status` ENUM('auto-graded', 'pending-review', 'fully-graded') NOT NULL DEFAULT 'auto-graded',
  `completed_at` TIMESTAMP NOT NULL,
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`schedule_id`) REFERENCES `exam_schedules`(`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Tabel untuk menyimpan jawaban esai
CREATE TABLE `essay_submissions` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `result_id` INT NOT NULL,
  `user_id` INT NOT NULL,
  `question_id` INT NOT NULL,
  `answer_text` TEXT,
  `status` ENUM('pending', 'graded') NOT NULL DEFAULT 'pending',
  `score` DECIMAL(5, 2) NULL,
  `graded_by` INT NULL,
  `graded_at` TIMESTAMP NULL,
  `submitted_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`result_id`) REFERENCES `results`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`question_id`) REFERENCES `questions`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Tabel untuk analisis butir soal
CREATE TABLE `question_analytics` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `question_id` INT NOT NULL,
  `schedule_id` INT NOT NULL,
  `difficulty_index` DECIMAL(5, 4) NULL,
  `discrimination_index` DECIMAL(5, 4) NULL,
  `analysis_run_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY `unique_analysis` (`question_id`, `schedule_id`),
  FOREIGN KEY (`question_id`) REFERENCES `questions`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`schedule_id`) REFERENCES `exam_schedules`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


-- =============================================
-- ===== TABEL KEAMANAN & LOGGING =====
-- =============================================

-- Tabel untuk mencatat event pelanggaran
CREATE TABLE `exam_events` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `session_id` INT NOT NULL,
  `user_id` INT NOT NULL,
  `event_type` VARCHAR(100) NOT NULL,
  `event_timestamp` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `details` TEXT,
  FOREIGN KEY (`session_id`) REFERENCES `exam_sessions`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Tabel untuk rate limiting login
CREATE TABLE `login_attempts` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `username` VARCHAR(50) NOT NULL,
  `ip_address` VARCHAR(45) NOT NULL,
  `attempt_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Tabel untuk audit trail
CREATE TABLE `audit_trail` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `user_id` INT NULL,
  `username` VARCHAR(50) NOT NULL,
  `action` VARCHAR(255) NOT NULL,
  `details` TEXT NULL,
  `ip_address` VARCHAR(45) NULL,
  `timestamp` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


-- =============================================
-- ===== INDEX UNTUK OPTIMASI PERFORMA =====
-- =============================================
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_results_user_id ON results(user_id);
CREATE INDEX idx_results_schedule_id ON results(schedule_id);
CREATE INDEX idx_sessions_user_id_status ON exam_sessions(user_id, status);
CREATE INDEX idx_progress_session_id ON exam_progress(session_id);
CREATE INDEX idx_events_session_id ON exam_events(session_id);
CREATE INDEX idx_schedule_questions_schedule_id ON schedule_questions(schedule_id);
CREATE INDEX idx_analytics_schedule_id ON question_analytics(schedule_id);
CREATE INDEX idx_set_items_set_id ON question_set_items(set_id);


-- =============================================
-- ===== CONTOH DATA AWAL =====
-- =============================================
-- Catatan: Anda harus membuat hash password sendiri menggunakan password_hash('password123', PASSWORD_BCRYPT) di PHP.
-- Hash di bawah ini hanya ilustrasi dan tidak akan berfungsi.
INSERT INTO `users` (`username`, `name`, `email`, `password`, `role`) VALUES
('admin', 'Admin Utama', 'admin@example.com', '$2y$10$D.Z.u9.p6A8.bY2jV9.l3kH7.4u2f.g5h.i6j.k7l.m8n.o9p', 'admin'),
('peserta01', 'Budi Santoso', 'budi@example.com', '$2y$10$E.A.a.b1c.d2e.f3g.h4i.j5k.l6m.n7o.p8q.r9s.t0u', 'participant');

INSERT INTO `questions` (`question_text`, `question_type`, `options`, `correct_answer_index`, `topic`, `difficulty`, `competency`, `status`) VALUES
('Ibu kota Indonesia adalah...', 'multiple-choice', '["Bandung", "Surabaya", "Jakarta", "Medan"]', 2, 'Tes Wawasan Kebangsaan', 'low', 'Pengetahuan Umum', 'approved');
